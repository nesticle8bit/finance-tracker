<div style="position:relative;">

  <!-- Trigger button -->
  <button type="button" class="picker-btn" (click)="isOpen ? close() : open()"
    [style.border-color]="isOpen ? '#14b8a6' : 'rgba(255,255,255,0.12)'">

    <mat-icon class="icon-md"
      [style.color]="selDay ? '#14b8a6' : 'rgba(255,255,255,0.3)'">
      calendar_today
    </mat-icon>

    @if (selDay) {
      <span class="picker-display">
        {{ displayValue }}
      </span>
    } @else {
      <span class="text-dim picker-placeholder">Seleccionar fecha...</span>
    }

    <mat-icon class="icon-md text-dim"
      style="transition:transform .2s;flex-shrink:0;"
      [style.transform]="isOpen ? 'rotate(180deg)' : 'rotate(0)'">
      expand_more
    </mat-icon>
  </button>

  <!-- Calendar dropdown -->
  @if (isOpen) {
    <div class="overlay-close" style="z-index:299;" (click)="close()"></div>

    <div class="cal-dropdown">

      <!-- Month navigation -->
      <div class="cal-nav">
        <button type="button" class="btn-icon-ghost" (click)="prevMonth(); $event.stopPropagation()">
          <mat-icon class="icon-md">chevron_left</mat-icon>
        </button>

        <span class="cal-title">{{ viewTitle }}</span>

        <button type="button" class="btn-icon-ghost" (click)="nextMonth(); $event.stopPropagation()">
          <mat-icon class="icon-md">chevron_right</mat-icon>
        </button>
      </div>

      <!-- Weekday headers -->
      <div class="cal-header-grid">
        @for (d of DAYS; track d) {
          <div class="cal-weekday">{{ d }}</div>
        }
      </div>

      <!-- Day cells -->
      <div class="cal-grid">
        @for (day of calendarDays; track $index) {
          <button type="button" [disabled]="!day" (click)="selectDay(day); $event.stopPropagation()"
            style="aspect-ratio:1;border:none;border-radius:8px;font-size:0.8rem;
                   font-family:'Sora',sans-serif;cursor:pointer;transition:all .15s;
                   display:flex;align-items:center;justify-content:center;position:relative;"
            [style.background]="isSelected(day) ? '#14b8a6'
                              : isToday(day)   ? 'rgba(20,184,166,0.15)'
                              : day             ? 'transparent'
                                                : 'transparent'"
            [style.color]="isSelected(day) ? '#000'
                         : isToday(day)   ? '#14b8a6'
                         : day            ? 'rgba(255,255,255,0.8)'
                                          : 'transparent'"
            [style.font-weight]="(isSelected(day) || isToday(day)) ? '700' : '400'"
            [style.cursor]="day ? 'pointer' : 'default'">
            {{ day || '' }}
            @if (isToday(day) && !isSelected(day)) {
              <span class="dot-today"></span>
            }
          </button>
        }
      </div>

      <!-- Footer: Hoy -->
      <div class="cal-footer">
        <button type="button" class="btn-teal-sm" (click)="selectToday(); $event.stopPropagation()">
          Hoy
        </button>
      </div>

    </div>
  }
</div>
