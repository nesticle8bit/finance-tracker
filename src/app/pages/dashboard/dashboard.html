<div class="page-pad">

  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title page-title--lg">Dashboard</h1>
      <p class="page-subtitle">{{ monthLabel() }}</p>
    </div>
    <button class="btn-primary" (click)="openAdd()">
      <mat-icon class="icon-md">add</mat-icon> Nuevo
    </button>
  </div>

  <!-- KPI Cards: 2 cols on mobile, 4 on desktop -->
  <div class="kpi-grid">
    <app-kpi-card label="Presupuesto" [value]="budgetFmt()" sub="Presupuesto mensual" icon="account_balance_wallet" color="blue" />
    <app-kpi-card label="Ingresos"    [value]="incomeFmt()"  [sub]="incomeCount()"     icon="arrow_downward"        color="green" />
    <app-kpi-card label="Gastos"      [value]="expenseFmt()" [sub]="expenseCount()"    icon="arrow_upward"          color="red" />

    <!-- Balance card -->
    <div class="card card-p-sm card-flex">
      <div class="flex items-center justify-between">
        <span class="card-title" style="margin:0;">Balance</span>
        <div class="icon-box-sm" style="background:rgba(20,184,166,0.1);">
          <mat-icon class="icon-sm text-brand">balance</mat-icon>
        </div>
      </div>
      <p class="value-lg" [style.color]="balancePos() ? '#2dd4bf' : '#f87171'">{{ balanceFmt() }}</p>
      <p class="text-dim text-xs-0">Ingresos − Gastos</p>
    </div>
  </div>

  <!-- Circular + Category bars -->
  <div class="dash-grid-1-2">

    <div class="card card-p col-center">
      <h3 class="card-title">Uso del Presupuesto</h3>
      <app-circular-progress [percentage]="pct()" [spent]="spentFmt()" [remaining]="remainFmt()" />
    </div>

    <div class="card card-p">
      <h3 class="card-title">Gastos por Categoría</h3>
      @if (categoryStats().length === 0) {
        <p class="empty-chart">Sin gastos este mes</p>
      } @else {
        <div class="form-stack" style="gap:20px;">
          @for (s of categoryStats(); track s.cat.id) {
            <app-category-bar [name]="s.cat.name" [icon]="s.cat.icon" [color]="s.cat.color"
              [amount]="formatCOP(s.total)" [percentage]="s.percentage" [limitPct]="s.limitPct" [limit]="s.limitLabel" />
          }
        </div>
      }
    </div>
  </div>

  <!-- Daily Chart + Recent Transactions -->
  <div class="dash-grid-1-1">

    <div class="card card-p">
      <h3 class="card-title">Gastos Diarios</h3>
      @if (!hasDailyData()) {
        <p class="empty-chart">Sin gastos registrados</p>
      } @else {
        <div class="daily-chart">
          @for (bar of dailyBars(); track bar.day) {
            <div class="daily-bar-col" [title]="'Día ' + bar.day">
              <div class="daily-bar-track">
                <div class="daily-bar"
                  [style.height.%]="Math.max(bar.pct, 4)"
                  [style.background]="bar.isToday ? 'linear-gradient(to top,#0d9488,#5eead4)' : 'rgba(20,184,166,0.35)'"
                  [style.opacity]="bar.isToday ? 1 : 0.7">
                </div>
              </div>
            </div>
          }
        </div>
        <div class="daily-labels">
          @for (bar of dailyBars(); track bar.day) {
            <div class="daily-label">{{ bar.day }}</div>
          }
        </div>
      }
    </div>

    <div class="card card-p">
      <div class="flex items-center justify-between" style="margin-bottom:24px;">
        <h3 class="card-title" style="margin:0;">Recientes</h3>
        <button (click)="goToTransactions()" class="btn-link-brand">Ver todo →</button>
      </div>

      @if (recentTransactions().length === 0) {
        <p class="empty-chart">Sin transacciones este mes</p>
      } @else {
        <div class="form-stack">
          @for (t of recentTransactions(); track t.id) {
            @let cat = getCategory(t.categoryId);
            <div class="txn-row">
              <div class="icon-box" [style.background]="(cat?.color ?? '#6b7280') + '20'">
                <mat-icon class="icon-sm" [style.color]="cat?.color ?? '#6b7280'">
                  {{ cat?.icon ?? 'more_horiz' }}
                </mat-icon>
              </div>
              <div class="flex-min">
                <p class="txn-desc">{{ t.desc }}</p>
                <p class="txn-meta">{{ formatDate(t.date) }} · {{ cat?.name }}</p>
              </div>
              <span class="txn-amount" [style.color]="t.type === 'income' ? '#4ade80' : '#f87171'">
                {{ t.type === 'income' ? '+' : '-' }}{{ formatCOP(t.amount) }}
              </span>
            </div>
          }
        </div>
      }
    </div>

  </div>
</div>
