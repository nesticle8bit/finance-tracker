<div class="page-pad">

  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Transacciones</h1>
      <p class="page-subtitle">Historial completo</p>
    </div>
    <button class="btn-primary" (click)="openAdd()">
      <mat-icon class="icon-md">add</mat-icon> Agregar
    </button>
  </div>

  <!-- Filters -->
  <div class="card card-p-xs" style="margin-bottom:24px;">
    <div class="filter-bar">
      <select class="input-field filter-select" [value]="filterType()"
        (change)="filterType.set($any($event.target).value)">
        <option value="">Todos los tipos</option>
        <option value="income">Ingresos</option>
        <option value="expense">Gastos</option>
      </select>

      <select class="input-field filter-select-wide" [value]="filterCat()"
        (change)="filterCat.set($any($event.target).value)">
        <option value="">Todas las categorías</option>
        @for (cat of finance.categories(); track cat.id) {
          <option [value]="cat.id">{{ cat.name }}</option>
        }
      </select>

      <select class="input-field filter-select-wide" [value]="filterMonth()"
        (change)="filterMonth.set($any($event.target).value)">
        <option value="">Todos los meses</option>
        @for (m of availableMonths(); track m.key) {
          <option [value]="m.key">{{ m.label }}</option>
        }
      </select>

      <input class="input-field filter-search" type="text" placeholder="Buscar descripción..."
        [value]="filterSearch()" (input)="filterSearch.set($any($event.target).value)">
    </div>
  </div>

  @if (filtered().length === 0) {
    <div class="card empty-state">Sin transacciones registradas</div>
  } @else {

    <!-- Desktop table (md and up) -->
    <div class="card txn-table" style="overflow:hidden;">
      <table>
        <thead>
          <tr class="tr-header">
            <th class="th-cell">Fecha</th>
            <th class="th-cell">Descripción</th>
            <th class="th-cell">Categoría</th>
            <th class="th-cell">Tipo</th>
            <th class="th-cell" style="text-align:right;">Monto</th>
            <th class="th-cell" style="text-align:right;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (t of filtered(); track t.id) {
            @let cat = getCategory(t.categoryId);
            <tr class="tr-hover">

              <td class="td-cell text-muted">{{ formatDate(t.date) }}</td>

              <td class="td-cell td-desc">{{ t.desc }}</td>

              <td class="td-cell">
                <div class="flex items-center" style="gap:8px;">
                  <div class="icon-box-xs" [style.background]="(cat?.color ?? '#6b7280') + '20'">
                    <mat-icon class="icon-xs" [style.color]="cat?.color ?? '#6b7280'">
                      {{ cat?.icon ?? 'more_horiz' }}
                    </mat-icon>
                  </div>
                  <span style="font-size:0.875rem;color:rgba(255,255,255,0.6);">{{ cat?.name ?? '—' }}</span>
                </div>
              </td>

              <td class="td-cell">
                <span class="badge" [class.badge-income]="t.type === 'income'" [class.badge-expense]="t.type === 'expense'">
                  {{ t.type === 'income' ? 'Ingreso' : 'Gasto' }}
                </span>
              </td>

              <td class="td-cell mono td-amount"
                [style.color]="t.type === 'income' ? '#4ade80' : '#f87171'">
                {{ t.type === 'income' ? '+' : '-' }}{{ formatCOP(t.amount) }}
              </td>

              <td class="td-cell" style="text-align:right;">
                <div class="flex items-center justify-end" style="gap:8px;">
                  <button class="btn-edit" (click)="openEdit(t)">
                    <mat-icon class="icon-xs">edit</mat-icon>
                    Editar
                  </button>
                  <button class="btn-danger" (click)="delete(t.id)">
                    <mat-icon class="icon-xs icon-v-mid">delete</mat-icon>
                    Eliminar
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Mobile card list (below md) -->
    <div class="txn-cards">
      @for (t of filtered(); track t.id) {
        @let cat = getCategory(t.categoryId);
        <div class="card card-p-xs">
          <!-- Top row: icon + desc + amount -->
          <div class="txn-row" style="margin-bottom:10px;">
            <div class="icon-box-md" [style.background]="(cat?.color ?? '#6b7280') + '22'">
              <mat-icon class="icon-md" [style.color]="cat?.color ?? '#6b7280'">
                {{ cat?.icon ?? 'more_horiz' }}
              </mat-icon>
            </div>
            <div class="flex-min">
              <p class="txn-mobile-desc">{{ t.desc }}</p>
              <p class="mono text-dim" style="font-size:0.75rem;margin:2px 0 0;">
                {{ cat?.name ?? '—' }} · {{ formatDate(t.date) }}
              </p>
            </div>
            <span class="mono txn-mobile-amount"
              [style.color]="t.type === 'income' ? '#4ade80' : '#f87171'">
              {{ t.type === 'income' ? '+' : '-' }}{{ formatCOP(t.amount) }}
            </span>
          </div>
          <!-- Bottom row: type badge + actions -->
          <div class="flex items-center justify-between row-divider-top" style="padding-top:10px;">
            <span class="badge" [class.badge-income]="t.type === 'income'" [class.badge-expense]="t.type === 'expense'">
              {{ t.type === 'income' ? 'Ingreso' : 'Gasto' }}
            </span>
            <div class="flex" style="gap:8px;">
              <button class="btn-edit" (click)="openEdit(t)">
                <mat-icon class="icon-xs">edit</mat-icon>
              </button>
              <button class="btn-danger flex items-center" style="gap:4px;" (click)="delete(t.id)">
                <mat-icon class="icon-xs icon-v-mid">delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      }
    </div>

  }
</div>
